<!DOCTYPE html>
<html lang="en">
<head>
  <title>Deploying MediaGoblin 1: FastCGI vs uWSGI</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="http://nathanielca.se/theme/css/main.css" type="text/css" />
      <link href="http://nathanielca.se/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Why Not Wingnut? Atom Feed" />
</head>

<body id="index" class="home">
  <header id="banner" class="body">
    <h1><a href="http://nathanielca.se/">Why Not Wingnut? </a></h1>
    <nav><ul>
        <li ><a href="http://nathanielca.se/category/civx.html">CIVX</a></li>
        <li class="active"><a href="http://nathanielca.se/category/fossrit.html">FOSS@RIT</a></li>
        <li ><a href="http://nathanielca.se/category/meta.html">meta</a></li>
        <li ><a href="http://nathanielca.se/category/personal.html">personal</a></li>
        <li><a href="http://qalthos.github.io/resume/resume.pdf">resume</a></li>
    </ul></nav>
  </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://nathanielca.se/fossrit/deploying-mediagoblin-1-fastcgi-vs-uwsgi.html" rel="bookmark"
           title="Permalink to Deploying MediaGoblin 1: FastCGI vs uWSGI">Deploying MediaGoblin 1: FastCGI vs uWSGI</a>
      </h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <p><img src="https://www.gravatar.com/avatar/3a3baabff105b46a458688ecf49901af" /></p>
        <abbr class="published" title="2013-09-23T13:20:00-04:00">
                Mon 23 September 2013
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://nathanielca.se/author/nathaniel-case.html">Nathaniel Case</a>
        </address>
<p>In <a href="http://nathanielca.se/category/fossrit.html">FOSS@RIT</a>. </p>
<p>tags: <a href="http://nathanielca.se/tag/mediagoblin.html">mediagoblin</a><a href="http://nathanielca.se/tag/yacht.html">yacht</a><a href="http://nathanielca.se/tag/uwsgi.html">uWSGI</a></p>
</footer><!-- /.post-info -->      <p>Last week I did a thing I really wasn't expecting to. I deployed
<a class="reference external" href="http://mediagoblin.org">MediaGoblin</a> to FOSS&#64;RIT's yacht server <a class="reference external" href="http://yacht.rit.edu/mediagoblin/">here</a>. The initial setup and
<a class="reference external" href="https://mediagoblin.readthedocs.org/en/v0.5.0/siteadmin/deploying.html">instructions</a> are some of the clearest and straightforward I have seen in an
open-source project.</p>
<p>There are several reasons I haven't written this up earlier. One of the reasons
was the web server configuration file was more complex than I was used to, so
in order to get the server running quickly, I made a new config file for port
8080. Unfortunately, due to various arcane networking policies, while this
allowed anyone inside RIT to access the server, it was still not available to
the outside world.</p>
<p>Also, though the instructions were very clear, they used a few things I had not
used before, and a few things that weren't used in the way I was used to them.
This is the first blog post on the subject, detailing my confusion with
FastCGI and its eventual replacement with uWSGI.</p>
<div class="section" id="what-the-flup">
<h2>What the <tt class="docutils literal">flup</tt>?</h2>
<p>MediaGoblin, as documented, uses FastCGI to route requests from the web server
to MediaGoblin. The CGI in FastCGI refers to the 'Common Gateway Interface',
a standard developed to allow web servers to act as 'gateways' to serve not
just files but the output of executable programs. The MediaGoblin docs describe
how to use a python module called <tt class="docutils literal">flup</tt> to enable this communication.</p>
<p>There's a bit more to it than that, but in Python land, this
turns out to be a more questionable prospect than it might seem. Python already
has its own gateway interface (called the web server gateway interface, or
WSGI) which it is using to talk to FastCGI to have the WSGI turned into CGI so
that it can be interpreted by the server and turned into a web page. This would
be fine except that there are other WSGI-specific modules which can translate
the WSGI into a web page directly.</p>
<p>At this point, I assume that you are either skipping ahead past things you
already know or are horribly lost, so I'll just say that I eventually moved
MediaGoblin from the <tt class="docutils literal"><span class="pre">paste-&gt;flup-&gt;FastCGI-&gt;nginx</span></tt> contraption it was to a more
comprehensible <tt class="docutils literal"><span class="pre">uWSGI-&gt;nginx</span></tt>, and this is how I did it.</p>
</div>
<div class="section" id="enter-uwsgi">
<h2>Enter uWSGI</h2>
<p>First, I changed the nginx config to talk to uWSGI instead of FastCGI.
As I was also trying to move MediaGoblin to a subdirectory, I also added the
<tt class="docutils literal">uWSGI_modifier1</tt> line and altered <tt class="docutils literal">SCRIPT_NAME</tt> accordingly:</p>
<div class="highlight"><pre><span></span><span class="c1"># Load MediaGoblin via uWSGI</span>
<span class="k">location</span> <span class="s">/mediagoblin/</span> <span class="p">{</span>
   <span class="kn">include</span> <span class="s">uWSGI_params</span><span class="p">;</span>
   <span class="kn">uWSGI_pass</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">26543</span><span class="p">;</span>

   <span class="c1"># our understanding vs nginx&#39;s handling of script_name vs</span>
   <span class="c1"># path_info don&#39;t match :)</span>
   <span class="kn">uWSGI_param</span> <span class="s">SCRIPT_NAME</span> <span class="s">&quot;/mediagoblin&quot;</span><span class="p">;</span>
   <span class="kn">uWSGI_modifier1</span> <span class="mi">30</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Second, I altered the <tt class="docutils literal">lazystarter.sh</tt> file to accommodate being run with
uWSGI. This is a bit complicated as <tt class="docutils literal">lazyserver.sh</tt>, <tt class="docutils literal">lazystarter.sh</tt>, and
<tt class="docutils literal">lazycelery.sh</tt> are all actually the same file, with certain things changing
depending on the name by which it is invoked. I changed two sections <a class="footnote-reference" href="#id2" id="id1">[1]</a>,
first:</p>
<div class="highlight"><pre><span></span><span class="nv">local_bin</span><span class="o">=</span><span class="s2">&quot;./bin&quot;</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$selfname</span><span class="s2">&quot;</span> in
    lazyserver.sh<span class="o">)</span>
        <span class="nv">starter_cmd</span><span class="o">=</span>paster
        <span class="nv">ini_prefix</span><span class="o">=</span>paste
        <span class="p">;;</span>
</pre></div>
<p>became:</p>
<div class="highlight"><pre><span></span><span class="nv">local_bin</span><span class="o">=</span><span class="s2">&quot;./bin&quot;</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$selfname</span><span class="s2">&quot;</span> in
    lazyserver.sh<span class="o">)</span>
        <span class="nv">starter_cmd</span><span class="o">=</span>uwsgi
        <span class="nv">ini_prefix</span><span class="o">=</span>paste
        <span class="p">;;</span>
</pre></div>
<p>And then near the very end of the file:</p>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CELERY_ALWAYS_EAGER</span><span class="o">=</span><span class="nb">true</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$selfname</span><span class="s2">&quot;</span> in
    lazyserver.sh<span class="o">)</span>
        <span class="nv">$starter</span> serve <span class="s2">&quot;</span><span class="nv">$ini_file</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span> --reload
        <span class="p">;;</span>
</pre></div>
<p>became:</p>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CELERY_ALWAYS_EAGER</span><span class="o">=</span><span class="nb">true</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$selfname</span><span class="s2">&quot;</span> in
    lazyserver.sh<span class="o">)</span>
        <span class="nv">$starter</span> --plugin python --virtualenv . --ini-paste <span class="s2">&quot;</span><span class="nv">$ini_file</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
        <span class="p">;;</span>
</pre></div>
<p>This method allows you to keep using all the information on how to run
MediaGoblin from paste.ini, while using uWSGI to do all the heavy lifting.
The socket still needs to be defined with the command, though, with
<tt class="docutils literal">./lazyserver.sh <span class="pre">--socket</span> 127.0.0.1:26543</tt> or whatever socket you are using.</p>
<p>As a side note, this also allows us to use your system's uWSGI <a class="reference external" href="http://uWSGI-docs.readthedocs.org/en/latest/Emperor.html">emperor</a> to
manage bringing up the uWSGI process for you. If you are running <a class="reference external" href="http://mediagoblin.readthedocs.org/en/v0.5.0/siteadmin/production-deployments.html#separate-celery">celery as a
separate process</a>, this still needs to be done somehow, but otherwise (or if
you've kept <tt class="docutils literal">CELERY_ALWAYS_EAGER=true</tt>), then MediaGoblin should be managed
automatically. This is the format I eventually settled upon, using the
following uWSGI ini file:</p>
<div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">plugin</span><span class="o">=</span><span class="s">python</span>
<span class="na">uid</span><span class="o">=</span><span class="s">mediagoblin</span>
<span class="na">gid</span><span class="o">=</span><span class="s">mediagoblin</span>
<span class="na">socket</span><span class="o">=</span><span class="s">127.0.0.1:26543</span>
<span class="na">virtualenv</span><span class="o">=</span><span class="s">/srv/www/mediagoblin</span>
<span class="na">chdir</span><span class="o">=</span><span class="s">/srv/www/mediagoblin</span>
<span class="na">ini-paste</span><span class="o">=</span><span class="s">/srv/www/mediagoblin/paste.ini</span>
<span class="na">logto</span><span class="o">=</span><span class="s">/srv/www/mediagoblin/mg.log</span>
</pre></div>
</div>
<div class="section" id="what-next">
<h2>What Next?</h2>
<p>As far as I can tell, this should have been all we needed to get running.
Well, this wouldn't have been necessary either, except for some of the
repercussions of the other big problem that reared it's head, SELinux.</p>
<p>But that is <a class="reference external" href="deploying-mediagoblin-2-selinux.html">another post</a>.</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>This statement is not entirely accurate. I actually made a new link
named <tt class="docutils literal">lazyuwsgi.sh</tt> and added the sections instead of altering the
existing ones. This format was chosen for clarity.</td></tr>
</tbody>
</table>
</div>

    </div><!-- /.entry-content -->
    <hr />
    <h5>Similar posts to this one</h5>
    <ul>
        <li><a href="http://nathanielca.se/fossrit/deploying-mediagoblin-2-selinux.html">Deploying MediaGoblin 2: SELinux</a></li>
    </ul>

  </article>
</section>
  <section id="extras" class="body">
    <div class="blogroll">
      <h2>blogroll</h2>
      <ul>
        <li><a href="http://foss.rit.edu">FOSS@RIT</a></li>
        <li><a href="http://yacht.rit.edu/planet/">FOSSBox Planet</a></li>
      </ul>
    </div><!-- /.blogroll -->
    <div class="social">
      <h2>social</h2>
      <ul>
        <li><a href="http://nathanielca.se/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

          <li><a href="http://github.com/Qalthos">Github</a></li>
          <li><a href="http://gplus.to/qalthos">Google+</a></li>
      </ul>
    </div><!-- /.social -->
  </section><!-- /#extras -->

  <footer id="contentinfo" class="body">
    <address id="about" class="vcard body">
      Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
    </address><!-- /#about -->

    <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
  </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-40338393-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>